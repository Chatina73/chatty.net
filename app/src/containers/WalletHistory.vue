<template>
  <div>
    <v-layout mt-5 wrap row>
      <v-flex xs12 mb-3 px-3>
        <div class="text-black font-weight-bold headline left">Transaction Activities</div>
        <div class="font-weight-bold right">
          <v-select
            class="pt-0 mt-0 ml-2 subtitle-2"
            height="25px"
            hide-details
            :value="'All Transaction'"
            :items="['All Transaction', 'Send', 'Receive']"
          ></v-select>
          <v-select class="pt-0 mt-0 ml-2 subtitle-2" height="25px" hide-details :value="'Period'" :items="['Period', 'Yead', 'Month']"></v-select>
        </div>
      </v-flex>

      <v-flex xs12 mb-3 px-3>
        <v-layout row class="caption">
          <v-flex xs12 sm2 py-3 px-4>Transaction</v-flex>
          <v-flex xs12 sm2 py-3 px-4>Date</v-flex>
          <v-flex xs12 sm2 py-3 px-4 class="text-xs-center">Amount</v-flex>
          <v-flex xs12 sm4 py-3 px-4>To</v-flex>
          <v-flex xs12 sm2 py-3 px-4 class="text-xs-center">Status</v-flex>
        </v-layout>

        <!-- List of activities -->
        <v-layout row class="activity-list body-2" v-for="n in 3" :key="n">
          <v-flex xs12 sm2 py-3 px-4>
            <v-icon>mdi-arrow-right-circle-outline</v-icon>
            Sent
          </v-flex>
          <v-flex xs12 sm2 py-3 px-4>
            10 Jun
          </v-flex>
          <v-flex xs12 sm2 py-3 px-4 class="text-xs-center">
            4.00000 ETH
          </v-flex>
          <v-flex xs12 sm4 py-3 px-4>
            0xdbb59a63bf5d4d0c32a20dc33e04008a71aa8b6e
          </v-flex>
          <v-flex xs12 sm2 py-3 px-4 class="text-xs-center">
            Pending
          </v-flex>
        </v-layout>
      </v-flex>
    </v-layout>
    <v-layout mt-5 row wrap align-start justify-center align-content-start v-if="false">
      <v-flex xs12 sm5>
        <span>
          <span class="spanWrapSvgStyle">
            <img :src="require('../../public/images/coins.svg')" alt="Wallet" class="svg-setting-small" />
          </span>
          <span class="text-bluish headline"> My Transactions</span>
        </span>
      </v-flex>
      <v-flex xs12 sm5 class="text-sm-right">
        <div>Total Portfolio Value</div>
        <div>
          <span>
            <span class="text-bluish headline spanWrapSvgStyle"> {{ totalPortfolioValue }} </span>
            <v-select
              class="select-width d-inline-flex ml-2 spanWrapSvgStyle"
              single-line
              solo
              text
              :items="supportedCurrencies"
              :value="selectedCurrency"
              label=""
              @change="onCurrencyChange"
            ></v-select>
          </span>
        </div>
      </v-flex>
      <v-flex xs12>
        <tx-history-table :headers="headers" :transactions="getTransactions()" />
      </v-flex>
      <v-flex xs12 mt-5>
        <v-layout row wrap>
          <v-flex offset-xs10 xs2 align-self-center class="hidden-xs-only">
            <img :src="require('../../public/images/torus_logo.png')" />
          </v-flex>
        </v-layout>
      </v-flex>
    </v-layout>
  </div>
</template>

<script>
// The color of dropdown icon requires half day work in modifying v-select
import config from '../config'
import TxHistoryTable from '../components/TxHistoryTable.vue'
import { addressSlicer, significantDigits, getEtherScanHashLink } from '../utils/utils'
import torus from '../torus'
const web3Utils = torus.web3.utils

export default {
  name: 'walletHistory',
  components: { TxHistoryTable },
  data() {
    return {
      supportedCurrencies: ['ETH', ...config.supportedCurrencies],
      headers: [
        {
          text: 'Date',
          align: 'left',
          value: 'date'
        },
        { text: 'From', value: 'slicedFrom', align: 'center' },
        { text: 'To', value: 'slicedTo', align: 'center' },
        { text: 'Amount', value: 'totalAmountString', align: 'center' },
        { text: 'Value', value: 'currencyAmountString', align: 'center' },
        { text: 'Status', value: 'status', align: 'center' }
      ]
    }
  },
  computed: {
    totalPortfolioValue() {
      return this.$store.getters.tokenBalances.totalPortfolioValue || '0'
    },
    selectedCurrency() {
      return this.$store.state.selectedCurrency
    },
    getCurrencyMultiplier() {
      const { selectedCurrency, currencyData } = this.$store.state || {}
      let currencyMultiplier = 1
      if (selectedCurrency !== 'ETH') currencyMultiplier = currencyData[selectedCurrency.toLowerCase()] || 1
      return currencyMultiplier
    }
  },
  methods: {
    onCurrencyChange(value) {
      this.$store.dispatch('setSelectedCurrency', value)
    },
    getTransactions() {
      const { networkId, transactions, networkType } = this.$store.state || {}
      const finalTransactions = []
      for (let tx in transactions) {
        const txOld = transactions[tx]
        if (txOld.metamaskNetworkId.toString() === networkId.toString()) {
          const txObj = {}
          txObj.id = txOld.time
          txObj.date = new Date(txOld.time).toDateString().substring(4)
          txObj.from = txOld.txParams.from
          txObj.slicedFrom = addressSlicer(txOld.txParams.from)
          txObj.to = txOld.txParams.to
          txObj.slicedTo = addressSlicer(txOld.txParams.to)
          txObj.totalAmount = web3Utils.fromWei(
            web3Utils.toBN(txOld.txParams.value).add(web3Utils.toBN(txOld.txParams.gas).mul(web3Utils.toBN(txOld.txParams.gasPrice)))
          )
          txObj.totalAmountString = `${significantDigits(txObj.totalAmount)} ETH`
          txObj.currencyAmount = this.getCurrencyMultiplier * txObj.totalAmount
          txObj.currencyAmountString = `${significantDigits(txObj.currencyAmount)} ${this.selectedCurrency}`
          txObj.status = txOld.status
          txObj.etherscanLink = getEtherScanHashLink(txOld.hash, networkType)
          finalTransactions.push(txObj)
        }
      }
      return finalTransactions
    }
  }
}
</script>

<style lang="scss" scoped>
@mixin svg-size($args...) {
  @each $name, $size in keywords($args) {
    .svg-setting-#{$name} {
      width: $size;
      height: $size;
    }
  }
}

@include svg-size($tiny: 18px, $small: 24px, $medium: 38px, $large: 80px);

%justify-align {
  justify-content: start;
  align-items: center;
}

.spanWrapSvgStyle {
  display: inline-flex;
  @extend %justify-align;
}

.text-bluish {
  color: var(--v-torus_blue-base);
}

.select-width {
  width: 80px;
}

::v-deep .v-text-field--solo .v-input__slot,
.v-text-field--outline .v-input__slot {
  min-height: auto !important;
  display: flex !important;
  align-items: flex-end !important;
  border-radius: 17px !important;
  box-shadow: 0 0 3px rgba(0, 0, 0, 0.16) !important;
  margin-top: 20px !important;
  margin-bottom: 0px !important;
}

::v-deep .v-text-field.v-text-field--solo .v-input__control {
  min-height: auto !important;
}

.activity-list {
  border-radius: 3px;
  box-shadow: 0 14px 28px 0 rgba(0, 0, 0, 0.06);
}
</style>
